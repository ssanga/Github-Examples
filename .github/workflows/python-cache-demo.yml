name: Python Cache Demo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  python-cache-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Display cache key components
      run: |
        echo "ðŸ”‘ Cache Key Components:"
        echo "Runner OS: ${{ runner.os }}"
        echo "Python Version: ${{ matrix.python-version }}"
        echo "Requirements file hash will be: $(python -c "import hashlib; print(hashlib.sha256(open('requirements.txt', 'rb').read()).hexdigest()[:8])")"
        echo ""
        echo "ðŸ“ Full cache key will be: ${{ runner.os }}-pip-${{ matrix.python-version }}-$(python -c "import hashlib; print(hashlib.sha256(open('requirements.txt', 'rb').read()).hexdigest())")"

    - name: Cache pip dependencies
      uses: actions/cache@v4
      id: cache-pip
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-

    - name: Check cache status
      run: |
        if [ "${{ steps.cache-pip.outputs.cache-hit }}" == "true" ]; then
          echo "ðŸŽ¯ Cache HIT! Dependencies restored from cache"
          echo "âš¡ This should be faster than the first run"
        else
          echo "âŒ Cache MISS! Will download and install dependencies"
          echo "ðŸŒ This will take longer (first run or requirements changed)"
        fi

    - name: Install dependencies (with timing)
      run: |
        echo "â±ï¸ Starting dependency installation at: $(date)"
        start_time=$(date +%s)
        
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        echo "â±ï¸ Installation completed in: ${duration} seconds"
        
        if [ "${{ steps.cache-pip.outputs.cache-hit }}" == "true" ]; then
          echo "ðŸ“Š This was a CACHED installation"
        else
          echo "ðŸ“Š This was a FRESH installation (will be cached for next time)"
        fi

    - name: Display installed packages
      run: |
        echo "ðŸ“¦ Installed packages:"
        pip list

    - name: Run Python application
      run: |
        echo "ðŸš€ Running Python application..."
        python app.py

    - name: Run basic tests
      run: |
        echo "ðŸ§ª Running basic tests..."
        python -c "import sys, requests, pandas as pd, numpy as np; print('âœ… All imports successful!')"

            - name: Cache statistics
            run: |
                echo "ðŸ“ˆ Cache Statistics:"
                echo "Cache directory size: $(du -sh ~/.cache/pip 2>/dev/null || echo 'Not available')"
                echo "Cache key used: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}"